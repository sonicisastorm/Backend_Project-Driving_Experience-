<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driving Experience Summary</title>
    <script src="https://kit.fontawesome.com/a49a2f08e3.js" crossorigin="anonymous"></script>
    <style>
        /* General body styling */
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #253628;
            color: #EBEBE9;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-sizing: border-box;
        }

        /* Header styling */
        header {
            background-color: #49654C;
            color: #EBEBE9;
            padding: 10px;
            width: 100%;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2;
            position: relative;
            animation: bounceIn 1s ease; /* Animation for header */
        }

        header h1 {
            font-size: 1.8rem;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Bounce-in animation for header */
        @keyframes bounceIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
            100% {
                transform: scale(1);
            }
        }

        /* Main content styling */
        main {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            z-index: 2;
            position: relative;
            animation: fadeInUp 1.5s ease; /* Animation for main content */
            width: 100%;
            box-sizing: border-box;
        }

        /* Fade-in animation for main content */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Summary box styling */
        .summary-box {
            background-color: #8AA989;
            padding: 25px;
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
        }

        /* Total distance text styling */
        .total-distance {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #FFF;
        }

        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            overflow-x: auto;
            display: block; /* Allow horizontal scrolling */
        }

        th, td {
            padding: 10px;
            border: 1px solid #C0CEB2;
            text-align: left;
            word-wrap: break-word;
        }

        th {
            background-color: #49654C;
            color: #EBEBE9;
        }

        /* Row styling for even and odd rows */
        tr:nth-child(even) {
            background-color: #A3E6DA;
        }

        tr:nth-child(odd) {
            background-color: #8AA989;
        }

        /* Button group styling */
        .toggle-buttons {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .toggle-buttons button {
            margin: 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: #49654C;
            color: #EBEBE9;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 1rem;
        }

        /* Button hover effect */
        .toggle-buttons button:hover {
            background-color: #A3E6DA;
            transform: scale(1.05);
        }

        /* Canvas styling for charts */
        canvas {
            margin-bottom: 30px;
            max-width: 100%;
        }

        /* Link styling */
        a {
            color: #A3E6DA;
            text-decoration: none;
            font-weight: bold;
        }

        a:hover {
            color: #49654C;
        }

        /* Footer styling */
        footer {
            background-color: #49654C;
            color: #EBEBE9;
            text-align: center;
            padding: 10px;
            position: relative;
            width: 100%;
            z-index: 2;
            box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Responsive design for smaller screens */
        @media (max-width: 600px) {
            header h1 {
                font-size: 1.4rem;
            }

            table th, table td {
                font-size: 0.8rem;
                padding: 8px;
            }

            .toggle-buttons button {
                font-size: 0.9rem;
                padding: 8px 16px;
            }

            canvas {
                max-width: 90%;
            }
        }

        @media (min-width: 601px) {
            header h1 {
                font-size: 1.8rem;
            }

            table th, table td {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fa-solid fa-car"></i> Driving Experience Summary</h1>
    </header>
    
    <main>
        <div class="summary-box">
            <!-- Display total distance traveled -->
            <div class="total-distance">
                Total Distance Traveled: <span id="totalDistance">0 km</span>
            </div>
            <h2><i class="fa-solid fa-circle-info"></i> Detailed Submissions</h2>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Mileage (km)</th>
                        <th>Weather</th>
                        <th>Traffic</th>
                        <th>Road Type</th>
                        <th>Visibility</th>
                    </tr>
                </thead>
                <tbody id="submission-details">
                    <!-- Submission details will be populated here -->
                </tbody>
            </table>

            <h2><i class="fa-solid fa-chart-simple"></i> Statistics</h2>
            <div class="toggle-buttons">
                <!-- Chart type selection buttons -->
                <button id="barChartButton">Bar Charts</button>
                <button id="pieChartButton">Pie Charts</button>
                <button id="lineChartButton">Line Graph</button>
            </div>
            <!-- Canvas elements for displaying charts -->
            <canvas id="weatherChart"></canvas>
            <canvas id="trafficChart"></canvas>
            <canvas id="roadChart"></canvas>
            <canvas id="visibilityChart"></canvas>
            <canvas id="lineChart" style="display: none;"></canvas>
        </div>

        <a href="step3.html"><i class="fa-solid fa-backward"></i> Back to Form</a>
    </main>
    
    <footer>
        <p><i class="fa-solid fa-copyright"></i> 2024. Driving Experience Assistant.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const submissionDetailsEl = document.getElementById("submission-details");
            const totalDistanceEl = document.getElementById("totalDistance");

            // Retrieve driving experiences from localStorage
            const drivingExperiences = JSON.parse(localStorage.getItem("drivingExperiences") || "[]");

            // Check if there are any driving experiences recorded
            if (drivingExperiences.length === 0) {
                submissionDetailsEl.innerHTML = '<tr><td colspan="8">No driving experiences recorded yet.</td></tr>';
                return;
            }

            // Options for various categories
            const weatherOptions = { "1": "Sunny", "2": "Rainy", "3": "Snowy", "4": "Windy", "5": "Foggy" };
            const trafficOptions = { "1": "Rush Hour", "2": "Rural Roads", "3": "Highways", "4": "Urban Areas" };
            const roadOptions = { "1": "Dry and Clear", "2": "Gravel or Loose Surface", "3": "Construction Zones", "4": "Debris" };
            const visibilityOptions = { "1": "Dust or Smoke", "2": "Heavy Rain", "3": "Snowfall", "4": "Sun Glare" };

            // Initialize counters and data for charts
            const counts = { weather: {}, traffic: {}, road: {}, visibility: {} };
            const lineChartData = { labels: [], data: [] };
            let totalDistance = 0;

            // Loop through each driving experience and populate the table and data
            drivingExperiences.forEach(exp => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${exp.date}</td>
                    <td>${exp["starting-time"]}</td>
                    <td>${exp["ending-time"]}</td>
                    <td>${exp.km}</td>
                    <td>${weatherOptions[exp.idWeatherCondition] || "Unknown"}</td>
                    <td>${trafficOptions[exp.idTrafficConditions] || "Unknown"}</td>
                    <td>${roadOptions[exp.idRoadType] || "Unknown"}</td>
                    <td>${visibilityOptions[exp.idVisibilityRange] || "Unknown"}</td>
                `;
                submissionDetailsEl.appendChild(row);

                // Calculate total distance and category counts
                totalDistance += parseFloat(exp.km);
                counts.weather[exp.idWeatherCondition] = (counts.weather[exp.idWeatherCondition] || 0) + 1;
                counts.traffic[exp.idTrafficConditions] = (counts.traffic[exp.idTrafficConditions] || 0) + 1;
                counts.road[exp.idRoadType] = (counts.road[exp.idRoadType] || 0) + 1;
                counts.visibility[exp.idVisibilityRange] = (counts.visibility[exp.idVisibilityRange] || 0) + 1;

                lineChartData.labels.push(exp.date);
                lineChartData.data.push(exp.km);
            });

            // Display the total distance
            totalDistanceEl.innerText = `${totalDistance} km`;

            Chart.register(ChartDataLabels); // Register Chart.js DataLabels plugin
            let chartInstances = []; // Array to hold chart instances

            // Prepare chart data based on selected options
            function prepareChartData(options, counts) {
                const labels = Object.keys(options).map(id => options[id]);
                const data = Object.keys(options).map(id => counts[id] || 0);
                return { labels, data };
            }

            // Render charts based on the selected type
            function renderCharts(chartType) {
                chartInstances.forEach(chart => chart.destroy()); // Destroy existing charts
                chartInstances = []; // Clear chart instances

                document.getElementById("lineChart").style.display = "none"; // Hide line chart
                ["weatherChart", "trafficChart", "roadChart", "visibilityChart"].forEach(id => {
                    document.getElementById(id).style.display = "block"; // Show other charts
                });

                // Prepare data for each chart type
                const chartData = [
                    { ctx: "weatherChart", title: "Weather Conditions", data: prepareChartData(weatherOptions, counts.weather) },
                    { ctx: "trafficChart", title: "Traffic Conditions", data: prepareChartData(trafficOptions, counts.traffic) },
                    { ctx: "roadChart", title: "Road Types", data: prepareChartData(roadOptions, counts.road) },
                    { ctx: "visibilityChart", title: "Visibility Ranges", data: prepareChartData(visibilityOptions, counts.visibility) }
                ];

                // Create charts for each dataset
                chartData.forEach(({ ctx, title, data }) => {
                    const total = data.data.reduce((sum, value) => sum + value, 0);
                    if (total === 0) return; // Skip if there is no data

                    const chartInstance = new Chart(document.getElementById(ctx), {
                        type: chartType,
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: title,
                                data: data.data,
                                backgroundColor: ['#9ACD32', '#32CD32', '#00FA9A', '#66CDAA', '#228B22']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true, position: 'top' },
                                title: { display: true, text: title },
                                datalabels: chartType === 'pie' ? {
                                    formatter: (value) => `${((value / total) * 100).toFixed(1)}%`,
                                    color: '#fff',
                                    font: { weight: 'bold' }
                                } : false
                            },
                            scales: chartType === 'bar' ? { y: { beginAtZero: true } } : {}
                        }
                    });
                    chartInstances.push(chartInstance); // Add chart instance to array
                });
            }

            // Render line chart specifically
            function renderLineChart() {
                chartInstances.forEach(chart => chart.destroy());
                chartInstances = [];

                document.getElementById("lineChart").style.display = "block"; // Show line chart
                ["weatherChart", "trafficChart", "roadChart", "visibilityChart"].forEach(id => {
                    document.getElementById(id).style.display = "none"; // Hide other charts
                });

                const lineChart = new Chart(document.getElementById("lineChart"), {
                    type: "line",
                    data: {
                        labels: lineChartData.labels,
                        datasets: [{
                            label: "Distance Traveled Over Time (km)",
                            data: lineChartData.data,
                            borderColor: "#32CD32",
                            backgroundColor: "rgba(50, 205, 50, 0.2)",
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: "Distance Traveled Over Time" }
                        },
                        scales: {
                            y: { beginAtZero: true },
                            x: { title: { display: true, text: "Date" } }
                        }
                    }
                });

                chartInstances.push(lineChart); // Add line chart to instances
            }

            renderCharts("bar"); // Initial render of bar charts

            // Event listeners for chart type buttons
            document.getElementById("barChartButton").addEventListener("click", () => renderCharts("bar"));
            document.getElementById("pieChartButton").addEventListener("click", () => renderCharts("pie"));
            document.getElementById("lineChartButton").addEventListener("click", renderLineChart);
        });
    </script>
    
</body>
</html>